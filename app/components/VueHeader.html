<!-- <script src="https://cdn.bootcss.com/qs/6.9.6/qs.min.js"></script> -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/emailjs-com@2/dist/email.min.js">
</script>
<script>
    Vue.component('vue-header', {
        template: `
        <header class="header">
        <div class="container d-flex justify-content-between align-items-center po-re py-2">
            <div class="d-flex">
                <a href="index.html">
                    <h1 class="h2 color-coffee font-bold">NINO CAR</h1>
                </a>
                <form class="d-md-none ml-5 po-re">
                    <input type="text" class="search-bar__input" placeholder="想找什麼車？" />
                    <button class="search-bar__btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 52 52" class="icon">
                            <g>
                                <circle cx="16.5" cy="16.5" r="16.5" transform="translate(7.175 5.413)" fill="none"
                                    stroke="#522613" stroke-linecap="round" stroke-linejoin="round" stroke-width="5" />
                                <circle cx="16.5" cy="16.5" r="10" transform="translate(7.175 5.413)" fill="none"
                                    stroke="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    class="hover-stroke-coffee" />
                                <line x1="10" y1="10" transform="translate(35.163 34.349)" fill="none" stroke="#522613"
                                    stroke-linecap="round" stroke-linejoin="round" stroke-width="5" />
                            </g>
                        </svg>
                    </button>
                </form>
            </div>
            <nav>
                <ul class="d-flex align-items-center">
                    <li class="lg-1" v-if="isLogin">
                        <a href="membermain.html" aria-label="member">
                            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 52 52"
                                class="icon">
                                <g transform="translate(3 6.5)">
                                    <g transform="translate(9 -1)" fill="none" stroke="#522613" stroke-width="5">
                                        <circle cx="14" cy="14" r="14" stroke="none" />
                                        <circle cx="14" cy="14" r="11.5" fill="none" />
                                    </g>
                                    <g transform="translate(4 29)" fill="none" stroke="#522613" stroke-width="5">
                                        <ellipse cx="18.5" cy="7.5" rx="18.5" ry="7.5" stroke="none" />
                                        <ellipse cx="18.5" cy="7.5" rx="16" ry="5" fill="none" />
                                    </g>
                                    <circle cx="2" cy="2" r="2" transform="translate(17 8.725)"
                                        class="hover-fill-coffee" fill="none" />
                                    <circle cx="2" cy="2" r="2" transform="translate(25 8.725)"
                                        class="hover-fill-coffee" fill="none" />
                                </g>
                            </svg>
                        </a>
                    </li>
                    <li class="lh-1 ml-10 ml-sm-5" v-if="isLogin">
                        <a href="MemberNotice.html" aria-label="message" @click.prevent="sendMail">
                            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 52 52"
                                class="icon">
                                <g transform="translate(6.473 4.772)">
                                    <path
                                        d="M32.3,14.12a11.12,11.12,0,0,0-22.24,0C10.06,27.094,4.5,30.8,4.5,30.8H37.86S32.3,27.094,32.3,14.12"
                                        transform="translate(-1.601 -0.584)" fill="none" stroke="#522613"
                                        stroke-linecap="round" stroke-linejoin="round" stroke-width="5" />
                                    <path d="M22.932,31.5a4.351,4.351,0,0,1-7.527,0" transform="translate(0.413 6.835)"
                                        fill="none" stroke="#522613" stroke-linecap="round" stroke-linejoin="round"
                                        stroke-width="5" />
                                    <path d="M22.3,8.281S25.877,9.8,25.621,18.86" fill="none" stroke="none"
                                        stroke-linecap="round" stroke-width="3" class="hover-stroke-coffee" />
                                </g>
                            </svg>
                        </a>
                    </li>
                    <li v-if="!isLogin">
                        <button class="header__btn" @click="isModalShow=true">登入 / 註冊</button>
                    </li>
                    <li class="ml-10 ml-sm-5 lh-1">
                        <svg role="button" aria-label="menu" xmlns="http://www.w3.org/2000/svg" width="40" height="40"
                            viewBox="0 0 50 50" class="icon" v-if="!isMenuShow" @click="isMenuShow=true">
                            <circle cx="25" cy="25" r="23" fill="none" stroke="#522613" stroke-width="4"
                                class="hover-fill-white" />
                            <line x1="15" y1="17" x2="35" y2="17" stroke="#522613" stroke-width="4"
                                stroke-linecap="round" />
                            <line x1="15" y1="25" x2="35" y2="25" stroke="#522613" stroke-width="4"
                                stroke-linecap="round" />
                            <line x1="15" y1="32" x2="35" y2="32" stroke="#522613" stroke-width="4"
                                stroke-linecap="round" />
                        </svg>
                        <svg role="button" aria-label="close" xmlns="http://www.w3.org/2000/svg" width="40" height="40"
                            viewBox="0 0 50 50" class="icon close-icon" v-if="isMenuShow" @click="isMenuShow=false">
                            <circle cx="25" cy="25" r="23" fill="#fff" stroke="#522613" stroke-width="4" />
                            <line x1="15" y1="15" x2="35" y2="35" stroke="#522613" stroke-width="4"
                                stroke-linecap="round" />
                            <line x1="15" y1="35" x2="35" y2="15" stroke="#522613" stroke-width="4"
                                stroke-linecap="round" />
                        </svg>
                    </li>
                </ul>
            </nav>
        </div>
        <link-group />
        <transition name="fade">
            <modal-member v-if="isModalShow" :is-error.sync="modalState['isError']" :content.sync="modalState['content']"
             :ui-state="modalState['uiState']" :sign-up-token="signUpInfo['token']" :sign-up-account="signUpInfo.account" 
             @close="handleModalClose" @login="handleLogin" @log-out="handleLogOut" @sign-up="handleSignUp" 
             @submit-token="handleCompleteSignUp" @done-account="handleAccountIsValidCheck"/>
        </transition>
        <transition name="collapse">
            <nav-menu v-if="isMenuShow" :login="isLogin" @log-out="handleLogOut"></nav-menu>
        </transition>
        <div class="modal-active" v-if="isMenuShow" @click="isMenuShow=false"></div>
    </header>`,
        data() {
            return {
                username: '',
                isLogin: false,
                modalState: {
                    isError: '',
                    content: 'login-content',
                    uiState: '',
                },
                signUpInfo: {
                    account: '',
                    password: '',
                    token: '',
                },
                isModalShow: false,
                isMenuShow: false,
            }
        },
        methods: {
            handleModalClose() {
                this.isModalShow = false;
                this.modalState.isError = '';
            },
            handleAccountIsValidCheck(theAccount) {
                this.modalState.isError = '';
                axios.post('http://localhost:8080/nino-scss/dist/assets/php/getMemberInfo.php', {
                        "account": theAccount,
                    }, ).then(res => {
                        console.log(res)
                        if (Array.isArray(res.data)) {
                            this.modalState.isError = '此帳號已被註冊';
                        } else {
                            this.modalState.isError = '';
                        }
                    })
                    .catch(error => {
                        console.log(error)
                    });

            },

            handleLogin(theAccount, thePassword) {
                this.modalState.isError = '';
                this.modalState.uiState = 'loading';
                axios.post('http://localhost:8080/nino-scss/dist/assets/php/login.php', {
                        "account": theAccount,
                        "password": thePassword
                    }, ).then(res => {
                        console.log(res)
                        this.modalState.uiState = '';

                        if (Array.isArray(res.data)) {
                            this.modalState.content = 'success-login-content';
                            this.isLogin = true;
                            setTimeout(() => {
                                this.isModalShow = false;
                            }, 4000)
                        } else {
                            this.modalState.isError = res.data;
                        }
                    })
                    .catch(error => {
                        console.log(error)
                    });

            },
            // handleLogOutModalShow() {
            //     this.isMenuShow = false;
            //     this.modalState.content = 'log-out-content';
            //     this.isModalShow = true;
            // },
            handleLogOut() {
                this.isMenuShow = false;
                this.isLogin = false;
                this.modalState.content = 'login-content';
                //會員頁寫判斷式回首頁
                //window.location = 'http://localhost:8080/nino-scss/dist/index-front.html'
            },
            handleSignUp(theAccount, thePassword) {
                if (this.modalState.isError === '') {
                    this.signUpInfo.account = theAccount;
                    this.signUpInfo.password = thePassword;
                    this.modalState.uiState = '傳送認證信中';
                    let templateParams = {
                        token: Math.floor(Math.random() * 1000),
                        userMail: theAccount,
                    }

                    let service_id = "service_p77rlm2";
                    let template_id = "template_8r123bp";
                    let userID = "user_DeGKwX1jMT522C5BEPsyo"
                    emailjs.send(service_id, template_id, templateParams, userID)
                        .then((response) => {
                            console.log('SUCCESS!', response.status, response.text);
                            this.modalState.uiState = '';
                            this.signUpInfo.token = templateParams.token;
                            this.modalState.content = 'confirm-token-content'
                        })
                        .catch((error) => {
                            console.log('FAILED...', error);
                            this.modalState.isError = error;
                        })
                }

            },
            handleCompleteSignUp() {
                this.modalState.uiState = 'loading';
                axios.post('http://localhost:8080/nino-scss/dist/assets/php/signUp.php', {
                        "account": this.signUpInfo.account,
                        "password": this.signUpInfo.password
                    }, ).then(res => {
                        console.log(res)
                        this.modalState.uiState = '';
                        if (res.data === "Connected Successfully") {
                            this.modalState.content = 'success-sign-up-content';
                            this.isLogin = true;
                            setTimeout(() => {
                                this.isModalShow = false;
                            }, 4000)
                        } else {
                            this.modalState.isError = res.data;
                        }
                    })
                    .catch(error => {
                        console.log(error)
                    });

            },
        }

        // handleLogin(theAccount, thePassword) {
        //     console.log(theAccount, thePassword)
        //     const qs = QS;
        //     const json = {
        //         "account": theAccount,
        //         "password": thePassword
        //     }
        //     axios.post('http://localhost:8080/nino-scss/app/assets/php/login.php', json, {
        //             //配置`transformRequest` ，在向伺服器傳送前，修改請求資料，axios會根據修改後的資料，自動設定請求頭
        //             transformRequest: [function (data) {
        //                 return qs.stringify(data); //把資料轉化為QueryString
        //             }]
        //         }).then(res => {
        //             console.log(res)
        //         })
        //         .catch(error => {
        //             console.log(error)
        //         });
        //     console.log('parents')


        //     // this.isLogin = true;
        //     // this.isModalShow = false
        // },


    });
</script>


@@include('./layout/HeaderLinkGroup.html')
@@include('./layout/HeaderNavMenu.html')
@@include('./ModalMember.html')