<!DOCTYPE html>
<html lang="en">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="./assets/css/all.css">
<link rel="stylesheet" href="./assets/css/pages/dictionary.css">
<script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.12/vue.js'></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
<script src="./assets/js/all.js"></script>
<title>Dictionary</title>
</head>

<body>
    <div id="dictionary">
        <vue-header></vue-header>
        <main class="container pt-25 pb-15">
            <!-- display -->
            <transition name="fade">
                @@include('./pages/DictionaryPage/DictionaryDisplaySection.html')
            </transition>
            <!--  list -->
            <section class="block">
                @@include('./pages/DictionaryPage/DictionaryPostNav.html')
                <transition name="collapse">
                    @@include('./pages/DictionaryPage/DictionaryFilterForm.html')
                </transition>
                @@include('./pages/DictionaryPage/DictionaryPostList.html')
            </section>
        </main>
        @@include('./components/Footer.html')
    </div>


    @@include('./components/VueHeader.html')
    @@include('./components/common/Pin.html')
    @@include('./pages/DictionaryPage/DictionaryPostItem.html')
    @@include('./pages/DictionaryPage/DictionaryPostPinSvg.html')


    <script>
        new Vue({
            el: '#dictionary',
            data: { //變數存放的地方
                productList: [],
                targetProduct: {},
                myProducts: [],
                showProductList: [],
                memberOwnProductIdList: ['300', '121'],
                memberHasPin: true,
                searchType: 'keyword',
                navClassName: {
                    'all': true,
                    'my': false
                },
                isNavbarShow: true,
                isModalShow: false,
                seriesList: [{
                    name: '工程系',
                    eName: 'EN',
                }, {
                    name: 'RV休旅系',
                    eName: 'RV',
                }, {
                    name: '計程車系',
                    eName: 'TA',
                }, {
                    name: '巴士系',
                    eName: 'BS',
                }, {
                    name: '警車系',
                    eName: 'PA',
                }, {
                    name: '消防救護系',
                    eName: 'EM',
                }, {
                    name: '轎車系',
                    eName: 'CA',
                }, {
                    name: 'PREMIUM系',
                    eName: 'PM',
                }],
                priceList: ['100~199', '200~299', '300以上'],
                yearList: ['1970~1989', '1990~2009', '2010後'],
                limitList: ['無限定', '期間限定', '點數限定'],
                selectedSeriesList: ['BS', 'EN', 'TA', 'EM', 'PM', 'PA', 'RV', 'CA'],
                selectedPriceList: ['100~199', '200~299', '300以上'],
                selectedYearList: ['1970~1989', '1990~2009', '2010後'],
                selectedLimitList: ['無限定', '期間限定', '點數限定'],
                keywordText: '',
            },
            mounted() {

                const getProductList = async () => {
                    const productList = await axios.get(
                        `./assets/php/getProductList.php`
                    );
                    return productList;
                }
                getProductList().then(res => {
                    console.log(res.data);
                    const fetchProductList = res.data.map(product => {
                        // 系列數字轉名稱
                        let thisSeriesIndex = parseInt(product[`product_series`]) - 1;
                        thisSeriesIndex.toString();
                        // 系列Id若是單位數，前面加0
                        let thisSeriesId;
                        if (product[`product_seriesid`].length === 1) {
                            thisSeriesId = 0 + product[`product_seriesid`];
                        } else {
                            thisSeriesId = product[`product_seriesid`];
                        }
                        return {
                            name: product[`product_name`],
                            eName: product['product_ename'],
                            series: this.seriesList[thisSeriesIndex].eName,
                            seriesIndex: thisSeriesIndex,
                            seriesId: thisSeriesId,
                            price: product[`product_price`],
                            imgURL: product['product_img'],
                            displayImgURL: product['product_img1'],
                            productId: product['product_id'],
                            year: product['product_year'],
                            size: product['product_size'],
                            description: product['product_des'],
                            limitLabel: product['product_spec'],
                        }
                    })
                    console.log(fetchProductList);
                    this.productList = fetchProductList;
                    this.showProductList = this.productList;
                    this.targetProduct = this.showProductList[0];
                }).catch(error => {
                    console.log(error)
                })
                // this.myProducts = this.productList.filter(product => this.memberOwnProductIdList.indexOf(product
                //     .productId));

            },
            computed: {
                bgClass() {
                    return `bg-series-${this.targetProduct.series}`
                },
                pinClass() {
                    return this.memberOwnProductIdList.indexOf(this.targetProduct.productId) ? 'pin' :
                        'pin pin--disabled'
                },
                limitLabel() {
                    if (this.targetProduct.limitLabel === '2') {
                        return {
                            text: '期間限定',
                            className: 'badge badge--primary'
                        };
                    } else if (this.targetProduct.limitLabel === '4') {
                        return {
                            text: '點數限定',
                            className: 'badge bg-blue'
                        };
                    }
                },
                priceAllCheck: {
                    get() {
                        return this.selectedPriceList ? this.selectedPriceList
                            .length === this.priceList.length : false
                    },
                    set(value) {
                        value ? this.selectedPriceList = [...this.priceList] : this
                            .selectedPriceList = [];
                    }
                },
                yearAllCheck: {
                    get() {
                        return this.selectedYearList ? this.selectedYearList
                            .length === this.yearList.length : false
                    },
                    set(value) {
                        value ? this.selectedYearList = [...this.yearList] : this
                            .selectedYearList = [];
                    }
                },
                seriesAllCheck: {
                    get() {
                        return this.selectedSeriesList ? this.selectedSeriesList.length === this.seriesList
                            .length : false
                    },
                    set(value) {
                        value ? this.selectedSeriesList = this.seriesList.map(series =>
                                series.eName) : this
                            .selectedSeriesList = [];
                    }
                },
                limitAllCheck: {
                    get() {
                        return this.selectedLimitList ? this.selectedLimitList
                            .length === this.limitList.length : false
                    },
                    set(value) {
                        value ? this.selectedLimitList = [...this.limitList] : this
                            .selectedLimitList = [];
                    }
                },
            },
            watch: {
                selectedPriceList(changedYearList) {
                    const changedProductList = this.productList.filter(product => {
                        let isInclude = false;
                        changedYearList.includes('100~199') && (product.price <= 199) ? isInclude =
                            true : '';
                        changedYearList.includes('300以上') && product.price >= 300 ? isInclude = true :
                            '';
                        if (changedYearList.includes('200~299')) {
                            product.price >= 200 && product.price <= 299 ? isInclude = true : '';
                        }
                        // 扣除點數限定商品（點數販售，價錢為0)
                        product.price == 0 ? isInclude = false : '';
                        return isInclude;
                    })
                    this.showProductList = changedProductList;
                },
                selectedYearList(changedYearList) {
                    const changedProductList = this.productList.filter(product => {
                        let isInclude = false;
                        changedYearList.includes('1970~1989') && product.year <= 1989 ? isInclude =
                            true : '';
                        changedYearList.includes('2010後') && product.year >= 2010 ? isInclude = true :
                            '';
                        if (changedYearList.includes('1990~2009')) {
                            product.year >= 1990 && product.year <= 2009 ? isInclude = true : '';
                        }
                        return isInclude;
                    })
                    this.showProductList = changedProductList;
                },
                selectedSeriesList(changedSeriesList) {
                    const changedProductList = this.productList.filter(product => {
                        return changedSeriesList.includes(product.series);
                    })
                    this.showProductList = changedProductList;
                },
                selectedLimitList(changedSeriesList) {
                    const changedProductList = this.productList.filter(product => {
                        let isInclude = false;
                        changedSeriesList.includes('期間限定') && product.limitLabel === '2' ? isInclude =
                            true : '';
                        changedSeriesList.includes('點數限定') && product.limitLabel === '4' ? isInclude =
                            true : '';
                        if (changedSeriesList.includes('無限定')) {
                            product.limitLabel !== '2' && product.limitLabel !== '4' ? isInclude =
                                true : '';
                        }
                        return isInclude;
                    })
                    this.showProductList = changedProductList;
                },
            },
            methods: {
                handleFilterReset() {
                    this.priceAllCheck = false;
                    this.yearAllCheck = false;
                    this.seriesAllCheck = false;
                    this.limitAllCheck = false;
                },
                handleFilterAllCheck() {
                    this.priceAllCheck = true;
                    this.yearAllCheck = true;
                    this.seriesAllCheck = true;
                    this.limitAllCheck = true;
                },
                handlePostClick(theProductId) {
                    this.targetProduct = this.showProductList.find(product => product.productId ===
                        theProductId)
                    this.isModalShow = true;
                },
                isPostPin(theProductId) {
                    return this.memberOwnProductIdList.indexOf(theProductId);
                },
                handleNavBarChange(filter) {
                    if (filter === 'my') {
                        this.showProductList = this.myProducts;
                        this.isNavbarShow = false;
                        this.navClassName = {
                            'all': false,
                            'my': true
                        };
                    } else if (filter === 'all') {
                        this.showProductList = this.productList;
                        this.isNavbarShow = true;
                        this.navClassName = {
                            'all': true,
                            'my': false
                        };
                    }
                },
                handleModalProductChange(order) {
                    const currentIndex = this.showProductList.indexOf(this.targetProduct);
                    if (order === 'prev') {
                        this.targetProduct = this.showProductList[currentIndex - 1];
                    } else if (order === 'next') {
                        this.targetProduct = this.showProductList[currentIndex + 1];
                    }
                },
                searchShowProduct() {
                    const filteredList = this.productList.filter(product => this.selectedSeriesFilter.indexOf(
                        product.series) >= 0);
                    console.log(filteredList);
                    this.showProductList = filteredList;
                },
                handleKeywordSearch() {
                    const filteredProductList = this.productList.filter(product => {
                        const keyword = this.keywordText.toLowerCase().trim();
                        let isIncludeWord = false;
                        product.name.toLowerCase().includes(keyword) ?
                            isIncludeWord = true : '';
                        product.eName.toLowerCase().includes(keyword) ?
                            isIncludeWord = true : '';
                        product.series.toLowerCase().includes(keyword) ?
                            isIncludeWord = true : '';
                        product.series.toLowerCase().concat(product.seriesId).includes(keyword) ?
                            isIncludeWord = true : '';
                        return isIncludeWord;
                    })
                    this.showProductList = filteredProductList;
                },

            },
        })
    </script>
</body>

</html>