<!DOCTYPE html>
<html lang="en">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="./assets/css/all.css">
<link rel="stylesheet" href="./assets/css/pages/dictionary.css">
<script src='https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.12/vue.js'></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vuex/3.6.2/vuex.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
<script src="./assets/js/utils.js"></script>
<title>Dictionary</title>
</head>

<body>
  <div id="dictionary" v-cloak>
    <vue-header></vue-header>
    <main class="container pt-25 pb-15">
      <!-- display -->
      <transition name="fade">
        @@include('./pages/DictionaryPage/DictionaryModalDiv.html')
      </transition>
      <!--  list -->
      <section class="block">
        @@include('./pages/DictionaryPage/DictionaryPostNav.html')
        <transition name="collapse">
          @@include('./pages/DictionaryPage/DictionaryFilterForm.html')
        </transition>
        <empty-state-div v-if="isLoginEmptyStateDivShow" class="block__body">
          <template v-slot:details>此頁面為會員專屬功能，<br>
            請先登入會員，以查看您的圖鑑和成就徽章</template>
        </empty-state-div>
        <empty-state-div v-if="isMemberEmptyStateDivShow" class="block__body">
          <template v-slot:details>尚未收集到圖鑑和成就，<br>
            完成訂單的車子，將在三天內匯入個人圖鑑</template>
          <template v-slot:link>
            <a href="./member.html" class="btn d-inbl text-center">查看訂單</a>
          </template>
        </empty-state-div>
        @@include('./pages/DictionaryPage/DictionaryPostList.html')
      </section>
    </main>
    @@include('./components/Footer.html')
  </div>

  @@include('./components/VueHeader.html')
  @@include('./components/PinSvg.html')
  @@include('./components/EmptyStateDiv.html')
  @@include('./pages/DictionaryPage/DictionaryPostItem.html')
  @@include('./pages/DictionaryPage/DictionaryPostPinSvg.html')

  <script>
    new Vue({
      el: '#dictionary',
      data: { //變數存放的地方
        productList: [],
        targetProduct: {},
        showProductList: [],
        myProductIdList: [],
        searchType: 'keyword',
        keywordText: '',
        activeNav: 'all',
        isModalShow: false,
        isLoading: true,
        yearList: ['1970~1989', '1990~2009', '2010後'],
        limitList: ['無限定', '期間限定', '點數限定'],
        selectedSeriesList: ['BS', 'EN', 'TA', 'EM', 'PM', 'PA', 'RV', 'CA'],
        selectedYearList: ['1970~1989', '1990~2009', '2010後'],
        selectedLimitList: ['無限定', '期間限定', '點數限定'],
      },
      mounted() {
        const getProductList = async () => {
          const result = await axios.get(
            `./assets/php/getProductList.php`
          );
          return result;
        }
        //拿所有商品清單
        getProductList().then(res => {
          console.log(res.data);
          this.isLoading = false;
          const fetchProductList = res.data.map(product => {
            // 系列數字轉名稱
            let thisSeriesIndex = parseInt(product[`product_series`]) - 1;
            thisSeriesIndex.toString();
            // 系列Id若是單位數，前面加0
            let thisSeriesId;
            if (product[`product_seriesid`].length === 1) {
              thisSeriesId = 0 + product[`product_seriesid`];
            } else {
              thisSeriesId = product[`product_seriesid`];
            }
            return {
              name: product[`product_name`].trim(),
              eName: product['product_ename'].trim().toUpperCase(),
              series: this.seriesList[thisSeriesIndex].eName,
              seriesIndex: thisSeriesIndex,
              seriesId: thisSeriesId,
              imgURL: product['product_img'],
              displayImgURL: product['product_img1'],
              productId: product['product_id'],
              year: product['product_year'],
              size: product['product_size'],
              description: product['product_des'],
              limitLabel: product['product_spec'],
            }
          })
          // console.log(fetchProductList);
          this.productList = fetchProductList;
          this.showProductList = this.productList;
          this.targetProduct = this.showProductList[0];
        }).catch(error => {
          console.log(error)
        })
      },
      store,
      computed: {
        //從store裡拿東西
        memberId() {
          return this.$store.state.memberId
        },
        seriesList() {
          return this.$store.state.seriesList
        },
        memberSeriesGroupCountList() { //搭配isMemberHasSeriesPin // pin-svg :disabled使用//
          if (this.myProductList.length === 0) {
            return [];
          } else {
            //先把過濾成只剩系列名
            const seriesList = this.myProductList.map(product => product.series);
            //每系列擁有的個數，若是各一種的徽章，最多為１
            const RVCount = seriesList.filter(series => series === "RV").length >= 1 ? 1 : 0;
            const BSCount = seriesList.filter(series => series === "BS").length >= 1 ? 1 : 0;
            const PACount = seriesList.filter(series => series === "PA").length >= 1 ? 1 : 0;
            const CACount = seriesList.filter(series => series === "CA").length >= 1 ? 1 : 0;
            const EMCount = seriesList.filter(series => series === "EM").length;
            const PMCount = seriesList.filter(series => series === "PM").length;
            const TACount = seriesList.filter(series => series === "TA").length;
            const ENCount = seriesList.filter(series => series === "EN").length;

            return [{
              name: 'RV',
              count: RVCount + BSCount,
            }, {
              name: 'BS',
              count: RVCount + BSCount,
            }, {
              name: 'PA',
              count: PACount + CACount,
            }, {
              name: 'CA',
              count: PACount + CACount,
            }, {
              name: 'EM',
              count: EMCount,
            }, {
              name: 'PM',
              count: PMCount,
            }, {
              name: 'TA',
              count: TACount
            }, {
              name: 'EN',
              count: ENCount
            }]
          }
        },
        bgClass() {
          return `bg-series-${this.targetProduct.series}`
        },
        pinClass() {
          return this.myProductIdList.indexOf(this.targetProduct.productId) >= 0 ? 'pin' :
            'pin pin--disabled'
        },
        limitLabel() {
          if (this.targetProduct.limitLabel === '2') {
            return {
              text: '期間限定',
              className: 'badge badge--primary'
            };
          } else if (this.targetProduct.limitLabel === '4') {
            return {
              text: '點數限定',
              className: 'badge bg-blue'
            };
          } else {
            return null
          }
        },
        myProductList() {
          if (this.productList && this.myProductIdList) {
            return this.productList.filter(product => this.myProductIdList.indexOf(product
              .productId) >= 0);
          } else {
            return [];
          }
        },
        isLoginEmptyStateDivShow() {
          if (!this.memberId && this.activeNav === 'my') {
            return true
          } else {
            return false
          }
        },
        isMemberEmptyStateDivShow() {
          if (this.memberId && this.activeNav === 'my') {
            return this.myProductList.length === 0 ? true : false;
          } else {
            return false;
          }
        },
        yearAllCheck: {
          get() {
            return this.selectedYearList ? this.selectedYearList
              .length === this.yearList.length : false
          },
          set(value) {
            value ? this.selectedYearList = [...this.yearList] : this
              .selectedYearList = [];
          }
        },
        seriesAllCheck: {
          get() {
            return this.selectedSeriesList ? this.selectedSeriesList.length === this.seriesList
              .length : false
          },
          set(value) {
            value ? this.selectedSeriesList = this.seriesList.map(series =>
                series.eName) : this
              .selectedSeriesList = [];
          }
        },
        limitAllCheck: {
          get() {
            return this.selectedLimitList ? this.selectedLimitList
              .length === this.limitList.length : false
          },
          set(value) {
            value ? this.selectedLimitList = [...this.limitList] : this
              .selectedLimitList = [];
          }
        },
      },
      watch: {
        selectedYearList() {
          this.handleShowProductListChange();
        },
        selectedSeriesList() {
          this.handleShowProductListChange();
        },
        selectedLimitList() {
          this.handleShowProductListChange();
        },
        myProductList(list) {
          if (this.activeNav === 'my') {
            this.showProductList = this.myProductList;
          }
        },
        memberId(val) {
          if (val) {
            this.handleGetMemberOwnProductIdList();
          } else {
            this.myProductIdList.splice(0)
          }
        },
      },
      methods: {
        isMemberHasPin(productId) {
          return this.myProductIdList.indexOf(productId) >= 0
        },
        isMemberHasSeriesPin(productSeriesName) {
          if (this.memberSeriesGroupCountList.length === 0) {
            return false
          }
          const series = this.memberSeriesGroupCountList.find(series => series.name === productSeriesName);
          const doubleList = ["RV", "BS", "PA", "CA"] //各一的徽章

          if (doubleList.indexOf(productSeriesName) < 0) { //三個以上的徽章
            return series.count >= 3;
          } else { //各一的徽章
            return series.count >= 2;
          }
        },
        handleSearchTypeChange() {
          this.showProductList = this.productList;
          if (this.searchType === 'sort') {
            this.searchType = 'keyword'
            this.keywordText = ''
          } else {
            this.searchType = 'sort';
            this.handleFilterAllCheck()
          }
        },
        handleShowProductListChange() {
          const filterYearProductList = this.productList.filter(product => {
            let isYearInclude = false;
            this.selectedYearList.includes('1970~1989') && product.year <= 1989 ?
              isYearInclude =
              true : '';
            this.selectedYearList.includes('2010後') && product.year >= 2010 ?
              isYearInclude =
              true :
              '';
            if (this.selectedYearList.includes('1990~2009')) {
              product.year >= 1990 && product.year <= 2009 ? isYearInclude = true : '';
            }
            return isYearInclude;
          })
          const filterSeriesProductList = filterYearProductList.filter(product => {
            return this.selectedSeriesList.includes(product.series);
          })
          const filterLimitProductList = filterSeriesProductList.filter(product => {
            let isLimitInclude = false;
            this.selectedLimitList.includes('期間限定') && product.limitLabel === '2' ?
              isLimitInclude =
              true : '';
            this.selectedLimitList.includes('點數限定') && product.limitLabel === '4' ?
              isLimitInclude =
              true : '';
            if (this.selectedLimitList.includes('無限定')) {
              product.limitLabel !== '2' && product.limitLabel !== '4' ? isLimitInclude =
                true : '';
            }
            return isLimitInclude;
          })
          this.showProductList = filterLimitProductList;
        },
        handleFilterReset() {
          this.yearAllCheck = false;
          this.seriesAllCheck = false;
          this.limitAllCheck = false;
        },
        handleFilterAllCheck() {
          this.yearAllCheck = true;
          this.seriesAllCheck = true;
          this.limitAllCheck = true;
        },
        handlePostClick(theProductId) {
          this.targetProduct = this.showProductList.find(product => product.productId ===
            theProductId)
          this.isModalShow = true;
        },
        handleNavBarChange(state) {
          if (state === 'my') {
            this.activeNav = state;
            this.showProductList = this.myProductList;
          } else if (state === 'all') {
            this.activeNav = state;
            this.showProductList = this.productList;
            this.searchType = 'keyword';
            this.keywordText = '';
          }
        },
        handleModalProductChange(order) {
          const currentIndex = this.showProductList.indexOf(this.targetProduct);
          if (order === 'prev') {
            this.targetProduct = this.showProductList[currentIndex - 1];
          } else if (order === 'next') {
            this.targetProduct = this.showProductList[currentIndex + 1];
          }
        },
        handleKeywordSearch() {
          const filteredProductList = this.productList.filter(product => {
            const keyword = this.keywordText.toLowerCase().trim();
            let isIncludeWord = false;
            product.name.toLowerCase().includes(keyword) ?
              isIncludeWord = true : '';
            product.eName.toLowerCase().includes(keyword) ?
              isIncludeWord = true : '';
            product.series.toLowerCase().includes(keyword) ?
              isIncludeWord = true : '';
            product.series.toLowerCase().concat(product.seriesId).includes(keyword) ?
              isIncludeWord = true : '';
            return isIncludeWord;
          })
          this.showProductList = filteredProductList;
        },
        handleGetMemberOwnProductIdList() {
          axios.post('./assets/php/getMemberOwnProductIdList.php', {
            "memberId": this.memberId,
          }).then(res => {
            console.log(res);
            if (Array.isArray(res.data) && res.data != []) {
              this.myProductIdList = res.data.map(obj => obj['product_id'])
            } else {
              console.log(res.data)
            }
          }).catch(error => {
            console.log(error)
          })
        }
      },
    })
  </script>
</body>

</html>